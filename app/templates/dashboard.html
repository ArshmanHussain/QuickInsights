<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Analytics Dashboard</a>
    <div class="d-flex">
      <a href="/logout" class="btn btn-outline-light">Logout</a>
    </div>
  </div>
</nav>

<div class="container mt-4">
    <h3>Welcome, {% if current_user is defined and current_user.is_authenticated %}{{ current_user.username }}{% else %}Guest{% endif %}</h3>
<hr>

<!-- CSV Upload Form -->
<form id="csvForm">
    <input type="file" id="file" name="file" accept=".csv" required>
    <button type="submit" class="btn btn-primary">Upload CSV</button>
</form>

<hr>

<!-- KPI Cards -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-center p-3 bg-primary text-white">
            <h5>Total Revenue</h5>
            <h3 id="totalRevenue">$0</h3>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center p-3 bg-success text-white">
            <h5>Total Orders</h5>
            <h3 id="totalOrders">0</h3>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center p-3 bg-warning text-white">
            <h5>Total Products</h5>
            <h3 id="totalProducts">0</h3>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card p-3">
            <h5>Sales Over Time</h5>
            <canvas id="salesChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card p-3">
            <h5>Revenue by Category</h5>
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card p-3">
            <h5>Top Products</h5>
            <canvas id="topProductsChart"></canvas>
        </div>
    </div>
</div>

</div>

<script>
let products = []; // CSV products array
let topProductsChart, salesChart, categoryChart;

// ------------------- CSV Upload -------------------
function uploadCSV() {
    const fileInput = document.getElementById("file");
    if(fileInput.files.length === 0){
        alert("Please select a CSV file.");
        return;
    }
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    fetch("/upload-csv", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        products = data;       // update CSV products array
        updateTopProductsChart();
        updateCategoryChart();
        updateTotalProductsKPI();
        updateTotalRevenueKPI();
    })
    .catch(err => {
        console.error(err);
        alert("CSV upload failed.");
    });
}

document.getElementById("csvForm").addEventListener("submit", function(e){
    e.preventDefault();
    uploadCSV();
});

// ------------------- Chart & KPI Updates -------------------
function updateTopProductsChart() {
    const ctx = document.getElementById("topProductsChart").getContext("2d");
    if(topProductsChart) topProductsChart.destroy();
    topProductsChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: products.map(p => p.name),
            datasets: [{
                label: "Quantity",
                data: products.map(p => p.quantity),
                backgroundColor: "rgba(54, 162, 235, 0.6)"
            }]
        }
    });
}

function updateCategoryChart() {
    const ctx = document.getElementById("categoryChart").getContext("2d");
    if(categoryChart) categoryChart.destroy();

    // Aggregate revenue by category
    const categoryRevenue = {};
    products.forEach(p => {
        const revenue = p.price * p.quantity;
        if(categoryRevenue[p.category]) categoryRevenue[p.category] += revenue;
        else categoryRevenue[p.category] = revenue;
    });

    categoryChart = new Chart(ctx, {
        type: "pie",
        data: {
            labels: Object.keys(categoryRevenue),
            datasets: [{
                label: "Revenue by Category",
                data: Object.values(categoryRevenue),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)'
                ]
            }]
        }
    });
}

function updateTotalProductsKPI() {
    document.getElementById("totalProducts").innerText = products.length;
}

function updateTotalRevenueKPI() {
    const totalRevenue = products.reduce((sum, p) => sum + (p.price * p.quantity), 0);
    document.getElementById("totalRevenue").innerText = "$" + totalRevenue.toLocaleString();
}

// ------------------- Existing API charts -------------------
async function fetchData(url) {
    const res = await fetch(url);
    return await res.json();
}

async function renderChartsAndKPI() {
    const revenueData = await fetchData('/api/sales-over-time');
    const ordersData = await fetchData('/api/top-products');

    // Sales Over Time Chart
    const salesCtx = document.getElementById("salesChart").getContext("2d");
    if(salesChart) salesChart.destroy();
    salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: revenueData.labels,
            datasets: [{
                label: 'Sales Over Time',
                data: revenueData.values,
                borderColor: 'rgba(75, 192, 192, 1)',
                fill: false
            }]
        }
    });

    // Total Orders KPI
    document.getElementById('totalOrders').innerText = ordersData.values.reduce((a,b)=>a+b,0);

    // Initial Category chart from API if products not yet uploaded
    const categoryData = await fetchData('/api/revenue-by-category');
    if(products.length === 0){
        const catCtx = document.getElementById("categoryChart").getContext("2d");
        categoryChart = new Chart(catCtx, {
            type: 'pie',
            data: {
                labels: categoryData.labels,
                datasets: [{
                    label: 'Revenue by Category',
                    data: categoryData.values,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)'
                    ]
                }]
            }
        });
    }

    // Initialize Top Products Chart if CSV is empty
    if(products.length === 0){
        updateTopProductsChart();
    }
}

// Initialize dashboard
renderChartsAndKPI();
</script>

</body>
</html>
